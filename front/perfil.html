<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil de Usuario</title>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@200..700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
      /* --- Estilos Generales (Iguales a tu archivo original) --- */
      body { font-family: 'Oswald', sans-serif; background-color: #f5f5f5; margin: 0; padding: 0; }
      header { background-color: #b00000; padding: 10px 0; text-align: center; color: white; }
      header h1 { margin: 0; font-size: 2.5rem; }
      nav { background: var(--nav); border-bottom: 1px solid var(--border); }
      .nav-wrap { width: 90%; max-width: 1200px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; }
      .navbar { list-style: none; display: flex; gap: 20px; margin: 0; padding: 10px 0; flex: 1; justify-content: space-between; }
      .navbar a { text-decoration: none; color: #ffffff; font-weight: 900; font-size: larger; } /* Corregido color texto nav */
      
      main { width: 90%; max-width: 1200px; margin: 20px auto; padding: 20px; background-color: #ffffff; border-radius: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
      .profile-container { text-align: center; }
      h2 { font-size: 2rem; margin-bottom: 20px; color: #1e3a8a; }

      /* Grid para Tarjetas */
      .grid-perfil {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      /* Estilos de Tarjeta (Miniatura) */
      .card-mini {
        background-color: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        text-align: left;
        transition: transform 0.2s;
      }
      .card-mini:hover { transform: translateY(-3px); }
      
      .card-media {
        width: 100%;
        height: 180px;
        object-fit: cover;
        background-color: #eee;
      }
      
      .card-body { padding: 15px; }
      .card-title { font-size: 1.2rem; margin: 0 0 10px; color: #b00000; }
      .card-text { font-size: 0.95rem; color: #555; }
      .card-price { color: #4CAF50; font-weight: bold; font-size: 1.1rem; margin-top: 5px;}

      /* Perfil Info */
      .profile-info { display: flex; justify-content: center; gap: 40px; margin-bottom: 30px; padding: 20px 0; flex-wrap: wrap; }
      .profile-details p, .profile-otherdets p, .profile-otherdets-ubi p { font-size: 1.2rem; margin: 5px 0; }
      .edit-button button { background-color: #1e3a8a; color: white; border: none; padding: 10px 20px; margin-top: 10px; font-size: 1rem; cursor: pointer; border-radius: 5px; }
      .edit-button button:hover { background-color: #3b5a9b; }
      
      /* Footer */
    footer { background: #eee; padding: 30px 20px; margin-top: 40px;}
    .footer-contenido { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; }
    .copyright { text-align: center; margin-top: 20px; }

    </style>
</head>
<body>
    <header>
      <h1>MundialFan</h1>
      <nav>
        <div class="nav-wrap">
          <ul class="navbar">
            <li><a href="index.html">Inicio</a></li>
            <li><a href="comunidad.html">Comunidad</a></li>
            <li><a href="tienda.html">Tienda</a></li>
            <li id="perfil-link"><a href="perfil.html">Mi Perfil</a></li>
          </ul>
        </div>
      </nav>
    </header>

    <main>
        <div class="profile-container">
            <h2 class="header-fonts">Perfil de Usuario</h2><br>
            
            <div class="profile-info">
                <div class="profile-image">
                    <img src='imagenes/default-profile.jpg' alt='Foto de perfil' height='150' width='150' style="border-radius: 50%;">
                    <div class="edit-button">
                        <a href="Editarperfil.html"><button>Editar Perfil</button></a>
                    </div>
                </div>

                <div class="profile-details">
                    <p><strong>Nombre:</strong> <span id="perfil-nombre">Cargando...</span></p>
                    <p><strong>Email:</strong> <span id="perfil-correo">Cargando...</span></p>
                </div>
                
                <div class="profile-other-group">
                    <div class="profile-otherdets-ubi">
                        <p><strong>Nacionalidad:</strong> <span id="perfil-nacionalidad">...</span></p>                    </div>
                </div>
            </div>

            <hr style="border: 0; border-top: 1px solid #ddd; margin: 30px 0;">

            <h2 class="header-fonts">Mis Posts</h2>
            <div id="contenedor-posts" class="grid-perfil">
                <p>Cargando publicaciones...</p>
            </div>
            <div class="edit-button">
                <a href="NuevoPost.html?origen=publicacion"><button>Crear Nuevo Post</button></a>
            </div>
            <br><br>

            <h2 class="header-fonts">Mis Productos en Venta</h2>
            <div id="contenedor-productos" class="grid-perfil">
                <p>Cargando productos...</p>
            </div>
            <div class="edit-button">
                <a href="NuevoPost.html?origen=producto"><button>Vender Producto</button></a>
            </div>
            <br>

            <br>
<hr style="border: 0; border-top: 1px solid #ddd; margin: 30px 0;">
<h2 class="header-fonts">Mis Estadísticas de Ventas</h2>

<div class="stats-dashboard" style="display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 30px;">
    <div class="stat-card-total" style="background: #1e3a8a; color: white; padding: 20px; border-radius: 10px; flex: 1; min-width: 250px; text-align: center;">
        <h3 style="margin:0; font-size: 1.5rem;">Ganancias Totales</h3>
        <p id="total-ingresos" style="font-size: 2.5rem; font-weight: bold; margin: 10px 0;">$0.00</p>
        <i class="fas fa-wallet" style="font-size: 2rem; opacity: 0.5;"></i>
    </div>
</div>

<div class="table-responsive" style="overflow-x: auto; background: white; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
    <table style="width: 100%; border-collapse: collapse; min-width: 500px;">
        <thead style="background: #b00000; color: white;">
            <tr>
                <th style="padding: 15px; text-align: left;">Producto</th>
                <th style="padding: 15px; text-align: center;">Unidades Vendidas</th>
                <th style="padding: 15px; text-align: right;">Ganancia Generada</th>
            </tr>
        </thead>
        <tbody id="tabla-ventas-body">
            <tr><td colspan="3" style="padding:20px; text-align:center;">Cargando estadísticas...</td></tr>
        </tbody>
    </table>
</div>
<br>

        </div>
    </main>

    <!-- FOOTER -->
  <footer>
    <div class="contenedor">
      <div class="footer-contenido">
        <div class="footer-seccion">
          <h4>MundialFan</h4>
          <p>Tu destino para todo lo relacionado con el Mundial de Fútbol. Ofrecemos las últimas noticias, estadísticas y contenido exclusivo.</p>
        </div>
        <div class="footer-seccion">
          <h4>Enlaces Rápidos</h4>
          <ul>
            <li><a href="#">Inicio</a></li>
            <li><a href="#">Calendario de Partidos</a></li>
            <li><a href="#">Resultados</a></li>
            <li><a href="#">Noticias</a></li>
          </ul>
        </div>
        <div class="footer-seccion">
          <h4>Contacto</h4>
          <p><i class="fas fa-map-marker-alt"></i> Av. del Fútbol 123, Ciudad Deportiva</p>
          <p><i class="fas fa-phone"></i> +1 234 567 8900</p>
          <p><i class="fas fa-envelope"></i> info@mundialfan.com</p>
        </div>
        <div class="footer-seccion">
          <h4>Síguenos</h4>
          <p>No te pierdas ninguna actualización sobre el mundial</p>
          <div class="redes-sociales">
            <a href="#"><i class="fab fa-facebook-f"></i></a>
            <a href="#"><i class="fab fa-twitter"></i></a>
            <a href="#"><i class="fab fa-instagram"></i></a>
            <a href="#"><i class="fab fa-youtube"></i></a>
          </div>
        </div>
      </div>
      <div class="copyright">
        <p>&copy; 2023 MundialFan. Todos los derechos reservados.</p>
      </div>
    </div>
  </footer>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
        cargarDatosPerfil();
        cargarContenidoUsuario();
        cargarEstadisticasVentas();
    });

    function cargarDatosPerfil() {
        fetch('obtenerPerfil.php', { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                document.getElementById('perfil-nombre').textContent = data.data.nombre_completo;
                document.getElementById('perfil-correo').textContent = data.data.correo;
                document.getElementById('perfil-nacionalidad').textContent = data.data.nacionalidad || 'N/A';
                document.getElementById('perfil-rol').textContent = data.data.rol;
                
                const navLink = document.querySelector('#perfil-link a');
                if(navLink) navLink.textContent = data.data.nombre_completo.split(' ')[0];
            } else {
                // Si no hay sesión, redirigir
                window.location.href = 'index.html';
            }
        })
        .catch(e => console.error("Error perfil:", e));
    }

    function cargarContenidoUsuario() {
        const divPosts = document.getElementById('contenedor-posts');
        const divProds = document.getElementById('contenedor-productos');
        
        // Mensaje de carga inicial
        divPosts.innerHTML = '<p>Buscando publicaciones...</p>';
        divProds.innerHTML = '<p>Buscando productos...</p>';

        fetch('obtener_perfil_contenido.php')
        .then(response => response.json())
        .then(data => {
            console.log("Datos recibidos:", data); // <--- MIRA ESTO EN LA CONSOLA (F12)

            // 1. Renderizar POSTS
            divPosts.innerHTML = ''; // Limpiar
            if (data.success && data.posts && data.posts.length > 0) {
                data.posts.forEach(post => {
                    divPosts.appendChild(crearTarjeta(post, 'post'));
                });
            } else {
                divPosts.innerHTML = '<p>No se encontraron publicaciones.</p>';
            }

            // 2. Renderizar PRODUCTOS
            divProds.innerHTML = ''; // Limpiar
            if (data.success && data.productos && data.productos.length > 0) {
                data.productos.forEach(prod => {
                    divProds.appendChild(crearTarjeta(prod, 'producto'));
                });
            } else {
                divProds.innerHTML = '<p>No se encontraron productos.</p>';
            }
        })
        .catch(error => {
            console.error('Error de red o JSON:', error);
            divPosts.innerHTML = '<p>Error al cargar contenido.</p>';
        });
    }

    function crearTarjeta(item, tipo) {
        const card = document.createElement('div');
        card.className = 'card-mini';
        
        // --- BLINDAJE CONTRA MAYÚSCULAS/MINÚSCULAS ---
        // MySQL a veces devuelve TITULO y a veces titulo. Esto cubre ambos casos.
        const titulo = item.titulo || item.TITULO || "Sin título";
        const url = item.url_contenido || item.URL_CONTENIDO;
        const fechaRaw = item.fecha_elaboracion || item.FECHA_ELABORACION;
        const precio = item.precio || item.PRECIO || 0;
        const tipoContenido = item.tipo || item.TIPO; // imagen o video
        
        // IDs seguros
        const idPost = item.id_publicacion || item.ID_PUBLICACION;
        const idProd = item.ID_PRODUCTO || item.id_producto;

        // Manejo de multimedia
        let mediaHtml = '';
        if (tipoContenido === 'video') {
            mediaHtml = `<video src="${url}" class="card-media" muted></video>`;
        } else {
            mediaHtml = `<img src="${url}" class="card-media" onerror="this.src='imagenes/blank.jpg'">`;
        }

        // Determinar Link
        let linkDetalle = '#';
        if (tipo === 'post') {
            linkDetalle = `Post.html?id=${idPost}`;
        } else {
            linkDetalle = `PostProducto.html?id=${idProd}`; // Asumiendo que existe esta página
        }

        let precioHtml = tipo === 'producto' 
            ? `<p class="card-price">$${parseFloat(precio).toFixed(2)}</p>` 
            : '';

        // Formatear fecha
        let fechaTexto = "Fecha desconocida";
        if(fechaRaw) {
            const f = new Date(fechaRaw);
            fechaTexto = f.toLocaleDateString();
        }

        card.innerHTML = `
            <a href="${linkDetalle}" style="text-decoration:none; color:inherit;">
                ${mediaHtml}
                <div class="card-body">
                    <h3 class="card-title">${titulo}</h3>
                    ${precioHtml}
                    <p class="card-text" style="font-size:0.8rem; color:#888;">
                        ${fechaTexto}
                    </p>
                </div>
            </a>
        `;
        return card;
    }

    function cargarEstadisticasVentas() {
    fetch('obtener_ventas.php')
    .then(res => res.json())
    .then(data => {
        const tbody = document.getElementById('tabla-ventas-body');
        const totalDisplay = document.getElementById('total-ingresos');
        
        if (data.success) {
            // 1. Actualizar Total General
            totalDisplay.textContent = `$${parseFloat(data.total_general).toFixed(2)}`;

            // 2. Llenar Tabla
            tbody.innerHTML = ''; // Limpiar
            
            if (data.data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="padding:20px; text-align:center;">Aún no has realizado ventas.</td></tr>';
                return;
            }

            data.data.forEach(item => {
                const row = document.createElement('tr');
                row.style.borderBottom = "1px solid #eee";
                
                row.innerHTML = `
                    <td style="padding: 15px; display:flex; align-items:center; gap:10px;">
                        <img src="${item.url_contenido}" style="width:40px; height:40px; object-fit:cover; border-radius:4px; background:#eee;" onerror="this.src='imagenes/blank.jpg'">
                        <span style="font-weight:bold; color:#333;">${item.TITULO}</span>
                    </td>
                    <td style="padding: 15px; text-align: center; font-size:1.1rem;">
                        ${item.cantidad_vendida}
                    </td>
                    <td style="padding: 15px; text-align: right; color:#4CAF50; font-weight:bold;">
                        $${parseFloat(item.total_ganado).toFixed(2)}
                    </td>
                `;
                tbody.appendChild(row);
            });
        } else {
            console.error("Error al cargar ventas:", data.message);
            tbody.innerHTML = '<tr><td colspan="3" style="padding:20px; text-align:center;">Error al cargar datos. Asegúrate de haber iniciado sesión.</td></tr>';
        }
    })
    .catch(err => {
        console.error(err);
        document.getElementById('tabla-ventas-body').innerHTML = '<tr><td colspan="3" style="padding:20px; text-align:center;">Error de conexión.</td></tr>';
    });
}
  </script>
</body>
</html>